# Скрипты управления инфраструктурой

Этот каталог содержит скрипты для управления хостинг-инфраструктурой.

## Файлы

### [`docker-compose.yml`](docker-compose.yml)
Определяет инфраструктурные сервисы:
- **nginx** — веб-сервер (порты 80, 443)
- **ssh** — SSH-доступ для клиентов (порт 2222)
- **portainer** — Web UI для управления Docker (порты 9000, 9443)
- **certbot** — получение SSL-сертификатов Let's Encrypt

### [`start.sh`](start.sh)
Скрипт запуска/остановки инфраструктуры.

**Использование:**
```bash
sudo ./start.sh              # Запуск всех сервисов и сайтов
sudo ./start.sh --no-sites   # Только инфраструктура без сайтов
sudo ./start.sh --force      # Остановить конфликтующие контейнеры и запустить
sudo ./start.sh --stop       # Остановить все сервисы
sudo ./start.sh --status     # Показать статус контейнеров
```

**Логика работы:**
1. Проверяет права доступа к Docker
2. Проверяет занятость портов (80, 443, 2222, 9000, 9443)
3. При --force останавливает конфликтующие контейнеры
4. Создаёт необходимые директории (letsencrypt, ssh/config, sites)
5. Запускает инфраструктурные сервисы
6. Находит и запускает все сайты из `../sites/*/docker-compose.yml`

### [`create_site.sh`](create_site.sh)
Интерактивный скрипт создания нового сайта.

**Использование:**
```bash
sudo ./create_site.sh                    # Интерактивный режим
sudo ./create_site.sh example.com        # С указанием домена
```

**Логика работы:**

1. **Проверки:**
   - Права доступа к Docker
   - Запущена ли инфраструктура (предлагает запустить)
   - Валидация домена
   - Существование сайта

2. **Интерактивные запросы:**
   - Домен (если не указан)
   - SSH-логин (по умолчанию: нормализованный домен)
   - Пароль SSH:
     * Сгенерировать автоматически (16 символов)
     * Ввести вручную (с подтверждением)
     * Без пароля (только по SSH-ключам)
   - Версия PHP (7.4, 8.0, 8.1, 8.2)
   - Email для Let's Encrypt

3. **Создание сайта:**
   - Создаёт директории `sites/<домен>/{www,logs}`
   - Копирует конфиги из шаблона `example.com`
   - Заменяет домен и имя контейнера в конфигах
   - Устанавливает выбранную версию PHP
   - Создаёт приветственную заглушку (красивая HTML-страница)

4. **Запуск контейнера:**
   - Запускает PHP-FPM контейнер сайта
   - Перезапускает nginx для подхвата нового vhost

5. **SSH-пользователь:**
   - Создаёт пользователя в контейнере `hosting_ssh`
   - Устанавливает пароль (если выбран)
   - Домашний каталог: `/srv/sites/<домен>`

6. **SSL-сертификат:**
   - Проверяет DNS-запись домена
   - Сравнивает с IP сервера
   - Если DNS корректен, получает сертификат Let's Encrypt
   - Перезапускает nginx после получения сертификата

**Выходные данные:**
- Домен и версия PHP
- Имя контейнера
- Статус SSL (получен / отложено / ошибка)
- SSH-доступ (хост, порт, логин, пароль)
- Пути к файлам сайта
- URL сайта (HTTP и HTTPS если сертификат получен)

## Требования

- Docker и Docker Compose
- Права root (sudo) для управления Docker
- Открытые порты: 80, 443, 2222, 9000, 9443
- Для SSL: DNS-запись домена должна указывать на IP сервера

## Примеры использования

### Первый запуск

```bash
# 1. Запустить инфраструктуру
cd /srv/hosting4/infra
sudo ./start.sh

# 2. Создать первый сайт
sudo ./create_site.sh example.com
```

### Добавление нового сайта

```bash
cd /srv/hosting4/infra
sudo ./create_site.sh newsite.com
```

### Остановка всех сервисов

```bash
cd /srv/hosting4/infra
sudo ./start.sh --stop
```

### Проверка статуса

```bash
cd /srv/hosting4/infra
sudo ./start.sh --status
```

## Структура созданного сайта

После выполнения `create_site.sh example.com`:

```
/srv/hosting4/
├── sites/example.com/
│   ├── docker-compose.yml       # Контейнер PHP-FPM
│   ├── www/
│   │   └── index.php            # Приветственная заглушка
│   └── logs/                    # Логи nginx и PHP
├── config/
│   ├── nginx/conf.d/
│   │   └── example.com.conf     # Виртуальный хост nginx
│   └── php-fpm/example.com/
│       ├── php.ini              # Настройки PHP
│       └── www.conf             # Настройки PHP-FPM пула
└── letsencrypt/etc/live/example.com/  # SSL-сертификаты (если получены)
```

## Troubleshooting

### Порты заняты

```bash
# Проверить какие контейнеры занимают порты
docker ps --format 'table {{.Names}}\t{{.Ports}}'

# Остановить конфликтующие контейнеры автоматически
sudo ./start.sh --force
```

### Нет прав доступа к Docker

```bash
# Добавить пользователя в группу docker
sudo usermod -aG docker $USER

# Перелогиниться
newgrp docker
```

### SSL-сертификат не получен

Проверьте:
1. DNS-запись домена указывает на IP сервера
2. Порт 80 открыт и доступен извне
3. Nginx запущен и обслуживает `/.well-known/acme-challenge/`

Получить сертификат вручную:
```bash
cd /srv/hosting4/infra
docker compose run --rm certbot certonly \
  --webroot -w /var/www/letsencrypt \
  -d example.com \
  --email your@email.com \
  --agree-tos

docker compose restart nginx
```
